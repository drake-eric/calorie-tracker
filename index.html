<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fuel ‚Äî Calorie Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&family=Playfair+Display:wght@400;600&family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
<style>

/* ===================== THEME VARIABLES ===================== */

/* DEFAULT: Dark Coal */
:root {
  --bg: #0f0e0d;
  --surface: #1a1917;
  --surface2: #232220;
  --border: #2e2c2a;
  --accent: #e8c547;
  --accent2: #e07a3a;
  --text: #f0ede8;
  --muted: #7a7672;
  --danger: #e05454;
  --good: #5ab88a;
  --ring-bg: #232220;
  --font-display: 'DM Serif Display', serif;
  --font-body: 'DM Sans', sans-serif;
  --tag-breakfast-bg: #1e1a0e; --tag-breakfast-fg: #e8c547;
  --tag-lunch-bg: #0e1a13;     --tag-lunch-fg: #5ab88a;
  --tag-dinner-bg: #1a0e16;    --tag-dinner-fg: #c47ab8;
  --tag-snack-bg: #1a120e;     --tag-snack-fg: #e07a3a;
  --tag-drink-bg: #0e1620;     --tag-drink-fg: #5ab0d8;
  --tag-drink-bg: #0e1620;     --tag-drink-fg: #5ab0d8;
  --setup-grad: linear-gradient(135deg,#1e1c0e,#1a1811);
  --weight-grad: linear-gradient(135deg,#0e1a13,#0d1a16);
  --recalc-grad: linear-gradient(135deg,#1a130e,#1a100d);
}

/* ---- GIRLY THEMES ---- */
[data-theme="rose"] {
  --bg: #fff5f7;
  --surface: #ffffff;
  --surface2: #fce9ee;
  --border: #f5c9d5;
  --accent: #e8557a;
  --accent2: #c4389e;
  --text: #3a1a24;
  --muted: #a07080;
  --danger: #d63060;
  --good: #47b87a;
  --ring-bg: #fce9ee;
  --font-display: 'Playfair Display', serif;
  --font-body: 'Quicksand', sans-serif;
  --tag-breakfast-bg: #fff0f3; --tag-breakfast-fg: #e8557a;
  --tag-lunch-bg: #edfff5;     --tag-lunch-fg: #47b87a;
  --tag-dinner-bg: #f8eeff;    --tag-dinner-fg: #c4389e;
  --tag-snack-bg: #fff8ee;     --tag-snack-fg: #e07a3a;
  --tag-drink-bg: #eef6ff;     --tag-drink-fg: #4a90d9;
  --setup-grad: linear-gradient(135deg,#fff0f3,#fce9ee);
  --weight-grad: linear-gradient(135deg,#edfff5,#e8fff2);
  --recalc-grad: linear-gradient(135deg,#fff8ee,#fff3e8);
}

[data-theme="lavender"] {
  --bg: #f7f4ff;
  --surface: #ffffff;
  --surface2: #ede8ff;
  --border: #d5caf5;
  --accent: #9b6fe8;
  --accent2: #e07ab8;
  --text: #2a1a40;
  --muted: #8878aa;
  --danger: #e05454;
  --good: #5ab88a;
  --ring-bg: #ede8ff;
  --font-display: 'Playfair Display', serif;
  --font-body: 'Quicksand', sans-serif;
  --tag-breakfast-bg: #fef8ff; --tag-breakfast-fg: #e07ab8;
  --tag-lunch-bg: #edfff5;     --tag-lunch-fg: #5ab88a;
  --tag-dinner-bg: #f0ebff;    --tag-dinner-fg: #9b6fe8;
  --tag-snack-bg: #fff8ee;     --tag-snack-fg: #e07a3a;
  --tag-drink-bg: #eef6ff;     --tag-drink-fg: #4a90d9;
  --setup-grad: linear-gradient(135deg,#f0ebff,#ede8ff);
  --weight-grad: linear-gradient(135deg,#edfff5,#e8fff2);
  --recalc-grad: linear-gradient(135deg,#fff8ee,#fff3e8);
}

[data-theme="peach"] {
  --bg: #fff8f4;
  --surface: #ffffff;
  --surface2: #fdeee5;
  --border: #f5d4c0;
  --accent: #e87a47;
  --accent2: #e84778;
  --text: #3a1a0a;
  --muted: #a07060;
  --danger: #d63030;
  --good: #47b87a;
  --ring-bg: #fdeee5;
  --font-display: 'Playfair Display', serif;
  --font-body: 'Quicksand', sans-serif;
  --tag-breakfast-bg: #fff5f0; --tag-breakfast-fg: #e87a47;
  --tag-lunch-bg: #edfff5;     --tag-lunch-fg: #47b87a;
  --tag-dinner-bg: #fff0f5;    --tag-dinner-fg: #e84778;
  --tag-snack-bg: #fffae8;     --tag-snack-fg: #c49a00;
  --tag-drink-bg: #eef6ff;     --tag-drink-fg: #4a90d9;
  --setup-grad: linear-gradient(135deg,#fff5f0,#fdeee5);
  --weight-grad: linear-gradient(135deg,#edfff5,#e8fff2);
  --recalc-grad: linear-gradient(135deg,#fff5f0,#fdeee0);
}

/* ---- NEUTRAL THEMES ---- */
[data-theme="light"] {
  --bg: #f5f4f2;
  --surface: #ffffff;
  --surface2: #eeece9;
  --border: #dddad5;
  --accent: #5a7a5a;
  --accent2: #8a6a3a;
  --text: #1a1917;
  --muted: #8a8680;
  --danger: #c05050;
  --good: #4a9a6a;
  --ring-bg: #eeece9;
  --font-display: 'DM Serif Display', serif;
  --font-body: 'DM Sans', sans-serif;
  --tag-breakfast-bg: #f5f0e0; --tag-breakfast-fg: #8a6a1a;
  --tag-lunch-bg: #eaf5ea;     --tag-lunch-fg: #4a7a4a;
  --tag-dinner-bg: #f0eaf5;    --tag-dinner-fg: #6a4a8a;
  --tag-snack-bg: #f5eee0;     --tag-snack-fg: #8a5a1a;
  --tag-drink-bg: #e8f0f8;     --tag-drink-fg: #4a7aaa;
  --setup-grad: linear-gradient(135deg,#f0ede8,#eeece9);
  --weight-grad: linear-gradient(135deg,#eaf5ea,#e4f0e4);
  --recalc-grad: linear-gradient(135deg,#f5eee0,#f5ead0);
}

[data-theme="slate"] {
  --bg: #1e2228;
  --surface: #272d35;
  --surface2: #30373f;
  --border: #3c4550;
  --accent: #64b8e8;
  --accent2: #e8a830;
  --text: #dde4ee;
  --muted: #7a8898;
  --danger: #e05454;
  --good: #5ab88a;
  --ring-bg: #30373f;
  --font-display: 'DM Serif Display', serif;
  --font-body: 'DM Sans', sans-serif;
  --tag-breakfast-bg: #2a3040; --tag-breakfast-fg: #64b8e8;
  --tag-lunch-bg: #1e3030;     --tag-lunch-fg: #5ab88a;
  --tag-dinner-bg: #2a2040;    --tag-dinner-fg: #9880d8;
  --tag-snack-bg: #302a1e;     --tag-snack-fg: #e8a830;
  --tag-drink-bg: #0e1828;     --tag-drink-fg: #4a90d8;
  --setup-grad: linear-gradient(135deg,#22303a,#1e2a34);
  --weight-grad: linear-gradient(135deg,#1e3028,#1a2e24);
  --recalc-grad: linear-gradient(135deg,#302818,#2a2010);
}

[data-theme="cream"] {
  --bg: #faf7f0;
  --surface: #ffffff;
  --surface2: #f2ede0;
  --border: #e0d8c8;
  --accent: #8a7a5a;
  --accent2: #c07850;
  --text: #2a2218;
  --muted: #9a9080;
  --danger: #c05050;
  --good: #5a9a6a;
  --ring-bg: #f2ede0;
  --font-display: 'DM Serif Display', serif;
  --font-body: 'DM Sans', sans-serif;
  --tag-breakfast-bg: #f8f0de; --tag-breakfast-fg: #8a6a30;
  --tag-lunch-bg: #e8f5e8;     --tag-lunch-fg: #4a7a50;
  --tag-dinner-bg: #f0e8f5;    --tag-dinner-fg: #7a5a8a;
  --tag-snack-bg: #f8ede0;     --tag-snack-fg: #c07850;
  --tag-drink-bg: #e8f0f8;     --tag-drink-fg: #4a7aaa;
  --setup-grad: linear-gradient(135deg,#f5f0e0,#f2ede0);
  --weight-grad: linear-gradient(135deg,#e8f5e8,#e0f0e0);
  --recalc-grad: linear-gradient(135deg,#f8ede0,#f5e4d0);
}

/* ---- MASCULINE THEMES ---- */
[data-theme="carbon"] {
  --bg: #111214;
  --surface: #1a1c1f;
  --surface2: #222427;
  --border: #2e3035;
  --accent: #00d4aa;
  --accent2: #ff6b35;
  --text: #e8ecf0;
  --muted: #6a7280;
  --danger: #ff4444;
  --good: #00d4aa;
  --ring-bg: #222427;
  --font-display: 'DM Sans', sans-serif;
  --font-body: 'DM Sans', sans-serif;
  --tag-breakfast-bg: #0e2020; --tag-breakfast-fg: #00d4aa;
  --tag-lunch-bg: #1a2010;     --tag-lunch-fg: #80d440;
  --tag-dinner-bg: #1a1030;    --tag-dinner-fg: #8080ff;
  --tag-snack-bg: #201808;     --tag-snack-fg: #ff6b35;
  --tag-drink-bg: #081820;     --tag-drink-fg: #30c0e8;
  --setup-grad: linear-gradient(135deg,#0e2020,#0a1818);
  --weight-grad: linear-gradient(135deg,#0e2018,#0a1814);
  --recalc-grad: linear-gradient(135deg,#201808,#1a1004);
}

[data-theme="navy"] {
  --bg: #0a0f1e;
  --surface: #111828;
  --surface2: #1a2235;
  --border: #253050;
  --accent: #e8b847;
  --accent2: #4a9fe8;
  --text: #e0e8f8;
  --muted: #607090;
  --danger: #e05454;
  --good: #47c87a;
  --ring-bg: #1a2235;
  --font-display: 'DM Serif Display', serif;
  --font-body: 'DM Sans', sans-serif;
  --tag-breakfast-bg: #1a1e10; --tag-breakfast-fg: #e8b847;
  --tag-lunch-bg: #0e1e14;     --tag-lunch-fg: #47c87a;
  --tag-dinner-bg: #0e1030;    --tag-dinner-fg: #4a9fe8;
  --tag-snack-bg: #1e1410;     --tag-snack-fg: #e87a47;
  --tag-drink-bg: #0a1828;     --tag-drink-fg: #4a9fe8;
  --setup-grad: linear-gradient(135deg,#1a1e10,#141a0a);
  --weight-grad: linear-gradient(135deg,#0e1e14,#0a1810);
  --recalc-grad: linear-gradient(135deg,#1e1410,#18100a);
}

[data-theme="gunmetal"] {
  --bg: #1c1c1c;
  --surface: #262626;
  --surface2: #303030;
  --border: #404040;
  --accent: #e84040;
  --accent2: #e88040;
  --text: #f0f0f0;
  --muted: #808080;
  --danger: #ff3333;
  --good: #40c080;
  --ring-bg: #303030;
  --font-display: 'DM Sans', sans-serif;
  --font-body: 'DM Sans', sans-serif;
  --tag-breakfast-bg: #2a2010; --tag-breakfast-fg: #e88040;
  --tag-lunch-bg: #102a14;     --tag-lunch-fg: #40c080;
  --tag-dinner-bg: #1a1010;    --tag-dinner-fg: #e84040;
  --tag-snack-bg: #201a10;     --tag-snack-fg: #c8a040;
  --tag-drink-bg: #101820;     --tag-drink-fg: #6080c0;
  --setup-grad: linear-gradient(135deg,#2a2010,#221a08);
  --weight-grad: linear-gradient(135deg,#102a14,#0a2010);
  --recalc-grad: linear-gradient(135deg,#201a10,#1a1408);
}

/* ===================== BASE STYLES ===================== */
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-body);
  min-height: 100vh;
  padding: 0 0 80px;
  transition: background 0.3s, color 0.3s;
}

/* ---- HEADER ---- */
.header {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 20px 24px 16px;
  position: sticky; top: 0; z-index: 50;
  transition: background 0.3s, border-color 0.3s;
}
.header-top { display: flex; justify-content: space-between; align-items: flex-start; }
.app-name {
  font-family: var(--font-display);
  font-size: 13px; letter-spacing: 0.12em;
  text-transform: uppercase; color: var(--accent); margin-bottom: 2px;
}
.date-display { font-size: 22px; font-weight: 600; line-height: 1.1; font-family: var(--font-display); }
.day-display { font-size: 13px; color: var(--muted); margin-top: 2px; }
.settings-btn {
  background: var(--surface2); border: 1px solid var(--border);
  color: var(--text); width: 38px; height: 38px; border-radius: 10px;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  font-size: 18px; transition: background 0.2s;
}
.settings-btn:hover { background: var(--border); }

/* ---- RING ---- */
.ring-section {
  padding: 28px 24px 20px;
  display: flex; flex-direction: column; align-items: center;
}
.ring-wrap { position: relative; width: 180px; height: 180px; }
.ring-svg { transform: rotate(-90deg); }
.ring-bg { fill: none; stroke: var(--ring-bg); stroke-width: 14; }
.ring-fill {
  fill: none; stroke: var(--accent); stroke-width: 14; stroke-linecap: round;
  transition: stroke-dashoffset 0.6s cubic-bezier(.4,0,.2,1), stroke 0.4s;
}
.ring-center {
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%); text-align: center;
}
.ring-remaining { font-family: var(--font-display); font-size: 36px; line-height: 1; }
.ring-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; margin-top: 4px; }
.cal-stats { display: flex; gap: 32px; margin-top: 20px; }
.stat { text-align: center; }
.stat-val { font-size: 18px; font-weight: 600; font-family: var(--font-display); }
.stat-lbl { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; margin-top: 2px; }

/* ---- SETUP BANNER ---- */
.setup-banner {
  margin: 0 16px 16px;
  background: var(--setup-grad);
  border: 1px solid var(--accent); border-radius: 14px;
  padding: 16px 18px; display: flex; align-items: center; gap: 14px;
}
.setup-icon { font-size: 28px; }
.setup-text { flex: 1; }
.setup-text strong { font-size: 15px; display: block; margin-bottom: 3px; }
.setup-text span { font-size: 13px; color: var(--muted); }
.setup-btn {
  background: var(--accent); color: var(--bg);
  border: none; padding: 8px 14px; border-radius: 8px;
  font-family: var(--font-body); font-weight: 700; font-size: 13px;
  cursor: pointer; white-space: nowrap; transition: opacity 0.2s;
}
.setup-btn:hover { opacity: 0.85; }

/* ---- SECTION HEADER ---- */
.section-header {
  padding: 4px 24px 12px;
  display: flex; justify-content: space-between; align-items: center;
}
.section-title { font-family: var(--font-display); font-size: 18px; }
.add-btn {
  background: var(--accent); color: var(--bg);
  border: none; padding: 8px 16px; border-radius: 10px;
  font-family: var(--font-body); font-weight: 700; font-size: 13px;
  cursor: pointer; display: flex; align-items: center; gap: 6px; transition: opacity 0.2s;
}
.add-btn:hover { opacity: 0.85; }

/* ---- ENTRIES ---- */
.entries-list { padding: 0 16px; display: flex; flex-direction: column; gap: 10px; }
.entry-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 14px; padding: 14px 16px;
  display: flex; gap: 12px; align-items: center;
  animation: slideIn 0.25s ease;
  transition: background 0.3s, border-color 0.3s;
}
@keyframes slideIn {
  from { opacity: 0; transform: translateY(10px); }
  to   { opacity: 1; transform: translateY(0); }
}
.entry-img {
  width: 52px; height: 52px; border-radius: 10px;
  background: var(--surface2); flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 22px; overflow: hidden;
}
.entry-img img { width: 100%; height: 100%; object-fit: cover; }
.entry-info { flex: 1; min-width: 0; }
.entry-name { font-weight: 600; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.entry-meta { font-size: 12px; color: var(--muted); margin-top: 3px; display: flex; gap: 8px; align-items: center; }
.entry-tag {
  font-size: 10px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.07em; padding: 2px 7px; border-radius: 20px;
}
.entry-tag.Breakfast { background: var(--tag-breakfast-bg); color: var(--tag-breakfast-fg); }
.entry-tag.Lunch     { background: var(--tag-lunch-bg);     color: var(--tag-lunch-fg); }
.entry-tag.Dinner    { background: var(--tag-dinner-bg);    color: var(--tag-dinner-fg); }
.entry-tag.Snack     { background: var(--tag-snack-bg);     color: var(--tag-snack-fg); }
.entry-tag.Drink     { background: var(--tag-drink-bg);     color: var(--tag-drink-fg); }
.entry-cals { font-family: var(--font-display); font-size: 20px; color: var(--accent); flex-shrink: 0; }
.entry-edit {
  background: var(--surface2); border: 1px solid var(--border); color: var(--muted);
  cursor: pointer; font-size: 13px; padding: 6px 10px; border-radius: 8px;
  transition: all 0.2s; flex-shrink: 0; font-family: var(--font-body); font-weight: 600;
  letter-spacing: 0.04em;
}
.entry-edit:hover { background: var(--border); color: var(--text); }
.empty-state { text-align: center; padding: 40px 24px; color: var(--muted); }
.empty-state .empty-icon { font-size: 40px; margin-bottom: 12px; }
.empty-state p { font-size: 14px; line-height: 1.6; }

/* ---- WEEK CHART ---- */
.week-section { padding: 0 16px; margin-top: 20px; }
.week-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 12px; }
.week-day { text-align: center; }
.week-day-label { font-size: 10px; color: var(--muted); text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.05em; }
.week-day-bar { height: 48px; background: var(--surface2); border-radius: 6px; position: relative; overflow: hidden; }
.week-day-fill {
  position: absolute; bottom: 0; left: 0; right: 0;
  background: var(--accent); border-radius: 6px; transition: height 0.5s cubic-bezier(.4,0,.2,1); opacity: 0.7;
}
.week-day-fill.over  { background: var(--danger); }
.week-day-fill.today { opacity: 1; }
.week-day-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--border); margin: 4px auto 0; }
.week-day-dot.today { background: var(--accent); }

/* ---- DAILY NOTE ---- */
.note-section { padding: 0 16px; margin-top: 20px; }
.note-input {
  width: 100%; background: var(--surface); border: 1px solid var(--border);
  border-radius: 12px; color: var(--text); font-family: var(--font-body);
  font-size: 14px; padding: 12px 14px; outline: none; resize: none;
  transition: border-color 0.2s, background 0.3s; min-height: 72px;
}
.note-input:focus { border-color: var(--accent); }
.note-input::placeholder { color: var(--muted); }

/* ---- MODALS ---- */
.modal-backdrop {
  position: fixed; inset: 0; background: rgba(0,0,0,0.6);
  z-index: 100; display: flex; align-items: flex-end; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity 0.25s;
}
.modal-backdrop.open { opacity: 1; pointer-events: all; }
.modal {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 24px 24px 0 0; padding: 24px 24px 40px;
  width: 100%; max-width: 500px;
  transform: translateY(40px);
  transition: transform 0.3s cubic-bezier(.4,0,.2,1), background 0.3s;
  max-height: 92vh; overflow-y: auto;
}
.modal-backdrop.open .modal { transform: translateY(0); }
.modal-handle {
  width: 40px; height: 4px; background: var(--border);
  border-radius: 2px; margin: 0 auto 20px;
}
.modal-title { font-family: var(--font-display); font-size: 22px; margin-bottom: 20px; }
.form-group { margin-bottom: 16px; }
.form-label {
  display: block; font-size: 12px; text-transform: uppercase;
  letter-spacing: 0.1em; color: var(--muted); margin-bottom: 8px; font-weight: 600;
}
.form-input {
  width: 100%; background: var(--surface2); border: 1px solid var(--border);
  border-radius: 12px; color: var(--text); font-family: var(--font-body);
  font-size: 15px; padding: 12px 14px; outline: none; transition: border-color 0.2s, background 0.3s;
}
.form-input:focus { border-color: var(--accent); }
.form-input::placeholder { color: var(--muted); }
select.form-input {
  cursor: pointer; appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%237a7672' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 14px center; padding-right: 36px;
}

/* ---- PROGRESS MODAL ---- */
.suggestion-card {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 12px; padding: 13px 14px;
  display: flex; gap: 12px; align-items: flex-start;
}
.suggestion-icon { font-size: 22px; flex-shrink: 0; margin-top: 1px; }
.suggestion-body { flex: 1; }
.suggestion-title { font-size: 14px; font-weight: 600; margin-bottom: 3px; }
.suggestion-text { font-size: 13px; color: var(--muted); line-height: 1.5; }
.suggestion-card.highlight { border-color: var(--accent); background: var(--setup-grad); }
.suggestion-card.highlight .suggestion-text { color: var(--text); opacity: 0.8; }

/* ---- FOOD SEARCH ---- */
.search-wrap { margin-bottom: 4px; }
.search-label {
  display: flex; align-items: center; gap: 8px;
  font-size: 12px; text-transform: uppercase; letter-spacing: 0.1em;
  color: var(--muted); margin-bottom: 8px; font-weight: 600;
}
.search-badge {
  background: var(--setup-grad); border: 1px solid var(--accent);
  color: var(--accent); font-size: 10px; font-weight: 700;
  padding: 2px 7px; border-radius: 20px; letter-spacing: 0.08em;
}
.search-row { display: flex; gap: 8px; }
.search-input {
  flex: 1; background: var(--surface2); border: 1px solid var(--border);
  border-radius: 12px; color: var(--text); font-family: var(--font-body);
  font-size: 15px; padding: 12px 14px; outline: none; transition: border-color 0.2s;
}
.search-input:focus { border-color: var(--accent); }
.search-input::placeholder { color: var(--muted); }
.search-btn {
  background: var(--accent); color: var(--bg); border: none;
  padding: 0 16px; border-radius: 12px; font-family: var(--font-body);
  font-weight: 700; font-size: 13px; cursor: pointer;
  min-width: 80px; display: flex; align-items: center; justify-content: center;
  transition: opacity 0.2s;
}
.search-btn:hover:not(:disabled) { opacity: 0.85; }
.search-btn:disabled { opacity: 0.45; cursor: not-allowed; }
.search-spinner {
  width: 16px; height: 16px; border: 2px solid rgba(0,0,0,0.2);
  border-top-color: var(--bg); border-radius: 50%;
  animation: spin 0.7s linear infinite; display: none;
}
.search-results {
  margin-top: 10px; background: var(--surface2);
  border: 1px solid var(--border); border-radius: 12px; overflow: hidden;
  display: none;
}
.search-results.visible { display: block; }
.search-result-item {
  padding: 11px 14px; border-bottom: 1px solid var(--border);
  cursor: pointer; transition: background 0.15s;
  display: flex; align-items: center; justify-content: space-between; gap: 10px;
}
.search-result-item:last-child { border-bottom: none; }
.search-result-item:hover { background: rgba(128,128,128,0.1); }
.search-result-name { font-size: 14px; font-weight: 600; line-height: 1.3; }
.search-result-sub { font-size: 11px; color: var(--muted); margin-top: 2px; }
.search-result-right { flex-shrink: 0; text-align: right; }
.search-result-cals { font-family: var(--font-display); font-size: 19px; color: var(--accent); }
.search-result-use { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--accent); opacity: 0.65; margin-top: 2px; }
.search-msg {
  padding: 16px 14px; text-align: center; color: var(--muted); font-size: 13px;
  display: flex; align-items: center; justify-content: center; gap: 10px;
}

/* ---- PHOTO UPLOAD ---- */
.photo-upload {
  border: 2px dashed var(--border); border-radius: 12px;
  padding: 20px; text-align: center; cursor: pointer;
  transition: border-color 0.2s, background 0.2s; position: relative; overflow: hidden;
}
.photo-upload:hover { border-color: var(--accent); background: rgba(128,128,128,0.05); }
.photo-upload input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
.photo-upload-icon { font-size: 28px; margin-bottom: 8px; }
.photo-upload-text { font-size: 13px; color: var(--muted); }
.photo-preview { width: 80px; height: 80px; border-radius: 10px; object-fit: cover; margin: 0 auto; display: block; }

/* ---- MODAL ACTIONS ---- */
.modal-actions { display: flex; gap: 12px; margin-top: 20px; }
.btn-cancel {
  flex: 1; background: var(--surface2); border: 1px solid var(--border);
  color: var(--text); padding: 14px; border-radius: 12px;
  font-family: var(--font-body); font-size: 15px; font-weight: 500;
  cursor: pointer; transition: background 0.2s;
}
.btn-cancel:hover { background: var(--border); }
.btn-save {
  flex: 2; background: var(--accent); border: none; color: var(--bg);
  padding: 14px; border-radius: 12px;
  font-family: var(--font-body); font-size: 15px; font-weight: 700;
  cursor: pointer; transition: opacity 0.2s;
}
.btn-save:hover { opacity: 0.85; }

/* ---- NOTIFICATIONS ---- */
.notification-bar {
  margin: 0 16px 12px;
  background: var(--weight-grad);
  border: 1px solid var(--good);
  border-radius: 14px; padding: 14px 18px;
  display: flex; align-items: center; gap: 14px;
}
.notification-bar.warning { background: var(--recalc-grad); border-color: var(--accent2); }
.notif-icon { font-size: 24px; }
.notif-text { flex: 1; }
.notif-text strong { font-size: 14px; display: block; margin-bottom: 2px; }
.notif-text span { font-size: 12px; color: var(--muted); }
.notif-btn {
  background: var(--good); color: #0f0e0d; border: none;
  padding: 7px 12px; border-radius: 8px;
  font-family: var(--font-body); font-weight: 700; font-size: 12px;
  cursor: pointer; white-space: nowrap;
}
.notification-bar.warning .notif-btn { background: var(--accent2); color: #fff; }

/* ---- THEME PICKER ---- */
.theme-section { margin-bottom: 24px; }
.theme-group-label {
  font-size: 11px; text-transform: uppercase; letter-spacing: 0.12em;
  color: var(--muted); margin-bottom: 10px; font-weight: 700;
}
.theme-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px; }
.theme-swatch {
  border-radius: 12px; padding: 10px 8px; cursor: pointer;
  display: flex; flex-direction: column; align-items: center; gap: 6px;
  border: 2px solid transparent; transition: border-color 0.2s, transform 0.15s;
  position: relative;
}
.theme-swatch:hover { transform: scale(1.03); }
.theme-swatch.active { border-color: var(--accent); }
.theme-swatch.active::after {
  content: '‚úì';
  position: absolute; top: 5px; right: 7px;
  font-size: 11px; font-weight: 700; color: var(--accent);
}
.swatch-dots { display: flex; gap: 4px; }
.swatch-dot { width: 12px; height: 12px; border-radius: 50%; }
.swatch-name { font-size: 11px; font-weight: 600; text-align: center; }

/* ---- DIVIDER ---- */
.modal-divider {
  display: flex; align-items: center; gap: 12px;
  color: var(--muted); margin-bottom: 16px;
}
.modal-divider span { font-size: 12px; text-transform: uppercase; letter-spacing: 0.1em; white-space: nowrap; }
.modal-divider::before, .modal-divider::after {
  content: ''; flex: 1; height: 1px; background: var(--border);
}

/* ---- PROTEIN BAR ---- */
.protein-section {
  padding: 0 24px 4px;
  display: none;
}
.protein-section.visible { display: block; }
.protein-header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 8px;
}
.protein-label { font-size: 12px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); font-weight: 600; }
.protein-nums { font-size: 13px; font-weight: 600; }
.protein-nums span { color: var(--accent); }
.protein-track {
  height: 10px; background: var(--surface2); border-radius: 20px; overflow: hidden;
}
.protein-fill {
  height: 100%; background: var(--good); border-radius: 20px;
  transition: width 0.5s cubic-bezier(.4,0,.2,1);
  min-width: 0; max-width: 100%;
}
.protein-fill.over { background: var(--accent); }

/* ---- GOAL TOGGLE ---- */
.goal-toggle { display: flex; gap: 10px; }
.goal-toggle-btn {
  flex: 1; padding: 12px 10px; border-radius: 12px; cursor: pointer;
  border: 2px solid var(--border); background: var(--surface2);
  color: var(--muted); font-family: var(--font-body); font-size: 14px;
  font-weight: 600; text-align: center; transition: all 0.2s;
  display: flex; flex-direction: column; align-items: center; gap: 4px;
}
.goal-toggle-btn .toggle-icon { font-size: 22px; }
.goal-toggle-btn:hover { border-color: var(--accent); color: var(--text); }
.goal-toggle-btn.active {
  border-color: var(--accent); background: var(--setup-grad); color: var(--accent);
}

.hidden { display: none !important; }
@media (max-width: 400px) { .cal-stats { gap: 20px; } }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-top">
    <div>
      <div class="app-name">Fuel</div>
      <div class="date-display" id="dateDisplay">‚Äî</div>
      <div class="day-display" id="dayDisplay">‚Äî</div>
    </div>
    <button class="settings-btn" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
  </div>
</div>

<!-- NOTIFICATIONS -->
<div id="notifications" style="padding-top:12px;"></div>

<!-- SETUP BANNER -->
<div class="setup-banner" id="setupBanner">
  <div class="setup-icon">üéØ</div>
  <div class="setup-text">
    <strong>Set your daily goal</strong>
    <span>Choose your goal and enter your calorie budget</span>
  </div>
  <button class="setup-btn" onclick="openSettings()">Set Up</button>
</div>

<!-- RING -->
<div class="ring-section">
  <div class="ring-wrap">
    <svg class="ring-svg" width="180" height="180" viewBox="0 0 180 180">
      <circle class="ring-bg" cx="90" cy="90" r="76"/>
      <circle class="ring-fill" id="ringFill" cx="90" cy="90" r="76"
        stroke-dasharray="477.5" stroke-dashoffset="477.5"/>
    </svg>
    <div class="ring-center">
      <div class="ring-remaining" id="remainingCals">‚Äî</div>
      <div class="ring-label" id="ringCenterLabel">remaining</div>
    </div>
  </div>
  <div class="cal-stats">
    <div class="stat">
      <div class="stat-val" id="goalDisplay">‚Äî</div>
      <div class="stat-lbl" id="goalStatLbl">Remaining</div>
    </div>
    <div class="stat">
      <div class="stat-val" id="consumedDisplay">0</div>
      <div class="stat-lbl">Eaten</div>
    </div>
    <div class="stat">
      <div class="stat-val" id="mealsDisplay">0</div>
      <div class="stat-lbl">Items</div>
    </div>
  </div>
</div>

<!-- PROTEIN BAR -->
<div class="protein-section" id="proteinSection">
  <div class="protein-header">
    <span class="protein-label">ü•© Protein</span>
    <span class="protein-nums"><span id="proteinConsumed">0</span>g / <span id="proteinGoalDisplay">‚Äî</span>g</span>
  </div>
  <div class="protein-track">
    <div class="protein-fill" id="proteinFill" style="width:0%"></div>
  </div>
</div>

<!-- WEEK CHART -->
<div class="week-section">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <span class="section-title">This Week</span>
  </div>
  <div class="week-days" id="weekDays"></div>
</div>

<!-- LOG SECTION -->
<div style="margin-top: 24px;">
  <div class="section-header">
    <span class="section-title">Today's Log</span>
    <button class="add-btn" onclick="openAddModal()">
      <span style="font-size:18px; line-height:1;">+</span> Add Fuel
    </button>
  </div>
  <div class="entries-list" id="entriesList">
    <div class="empty-state" id="emptyState">
      <div class="empty-icon">üçΩÔ∏è</div>
      <p>No meals logged yet.<br>Tap "Add Fuel" to get started.</p>
    </div>
  </div>
</div>

<!-- DAILY NOTE -->
<div class="note-section" style="margin-top:24px;">
  <div style="padding: 0 8px 10px;">
    <span class="section-title">Daily Notes</span>
  </div>
  <textarea id="dailyNote" class="note-input" placeholder="How are you feeling? Water intake, energy levels, notes‚Ä¶" oninput="saveNote()"></textarea>
</div>

<!-- SEE MY PROGRESS BUTTON -->
<div style="padding: 20px 16px 0;">
  <button onclick="openProgress()" style="width:100%; background:var(--surface); border:1px solid var(--border); color:var(--text); padding:16px; border-radius:14px; font-family:var(--font-body); font-size:15px; font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; transition:background 0.2s;">
    <span style="font-size:22px;">üìä</span> See My Progress
  </button>
</div>


<!-- =================== PROGRESS MODAL =================== -->
<div class="modal-backdrop" id="progressModal">
  <div class="modal" style="border-radius:24px 24px 0 0; max-height:92vh;">
    <div class="modal-handle"></div>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <div class="modal-title" style="margin-bottom:0;">My Progress</div>
      <button onclick="closeProgress()" style="background:var(--surface2);border:1px solid var(--border);color:var(--muted);width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;transition:color 0.2s;" onmouseover="this.style.color='var(--text)'" onmouseout="this.style.color='var(--muted)'">‚úï</button>
    </div>

    <!-- GOAL PROGRESS BAR -->
    <div id="progressGoalSection" style="margin-bottom:20px; display:none;">
      <div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:8px;">
        <span style="font-family:var(--font-display); font-size:16px;">Goal Progress</span>
        <span id="progressGoalPct" style="font-size:13px; color:var(--accent); font-weight:600;"></span>
      </div>
      <div style="height:12px; background:var(--surface2); border-radius:20px; overflow:hidden; margin-bottom:10px;">
        <div id="progressGoalBar" style="height:100%; border-radius:20px; background:var(--accent); transition:width 0.6s cubic-bezier(.4,0,.2,1); width:0%;"></div>
      </div>
      <div style="display:flex; justify-content:space-between;">
        <div style="text-align:left;">
          <div style="font-size:18px; font-weight:700; font-family:var(--font-display);" id="progressStartLbl">‚Äî</div>
          <div style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.08em;">Start</div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:18px; font-weight:700; font-family:var(--font-display); color:var(--accent);" id="progressCurrentLbl">‚Äî</div>
          <div style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.08em;">Now</div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:18px; font-weight:700; font-family:var(--font-display);" id="progressGoalLbl">‚Äî</div>
          <div style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.08em;">Goal</div>
        </div>
      </div>
      <div id="progressEtaBox" style="margin-top:14px; background:var(--setup-grad); border:1px solid var(--accent); border-radius:12px; padding:12px 14px; font-size:13px; line-height:1.5;"></div>
    </div>

    <!-- WEIGHT CHART -->
    <div style="margin-bottom:20px;">
      <div style="font-family:var(--font-display); font-size:16px; margin-bottom:12px;">Weight History</div>
      <div id="weightChartWrap" style="position:relative; height:160px; background:var(--surface2); border-radius:14px; overflow:hidden;">
        <canvas id="weightChart" style="width:100%; height:100%;"></canvas>
        <div id="weightChartEmpty" style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--muted);font-size:13px;gap:6px;">
          <span style="font-size:28px;">‚öñÔ∏è</span>
          <span>Log your weight weekly to see your trend</span>
        </div>
      </div>
    </div>

    <!-- STATS ROW -->
    <div id="progressStatsRow" style="display:none; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:20px;">
      <div style="background:var(--surface2); border-radius:12px; padding:12px; text-align:center;">
        <div style="font-family:var(--font-display); font-size:20px; color:var(--accent);" id="statChange">‚Äî</div>
        <div style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.07em; margin-top:3px;" id="statChangeLbl">Change</div>
      </div>
      <div style="background:var(--surface2); border-radius:12px; padding:12px; text-align:center;">
        <div style="font-family:var(--font-display); font-size:20px; color:var(--accent);" id="statWeeks">‚Äî</div>
        <div style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.07em; margin-top:3px;">Weeks</div>
      </div>
      <div style="background:var(--surface2); border-radius:12px; padding:12px; text-align:center;">
        <div style="font-family:var(--font-display); font-size:20px; color:var(--accent);" id="statAvgWeekly">‚Äî</div>
        <div style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.07em; margin-top:3px;">Avg/Week</div>
      </div>
    </div>

    <!-- SUGGESTIONS -->
    <div id="progressSuggestions" style="display:none;">
      <div style="font-family:var(--font-display); font-size:16px; margin-bottom:12px;">üí° Personalized Tips</div>
      <div id="suggestionsList" style="display:flex; flex-direction:column; gap:10px;"></div>
    </div>

    <!-- NO DATA -->
    <div id="progressNoData" style="text-align:center; padding:20px 0; color:var(--muted); font-size:14px; display:none;">
      <div style="font-size:36px; margin-bottom:12px;">üå±</div>
      Set your current weight and goal weight in Settings to get started.
    </div>

  </div>
</div>

<!-- =================== ADD FOOD MODAL =================== -->
<div class="modal-backdrop" id="addModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Log Fuel</div>

    <!-- FOOD SEARCH -->
    <div class="search-wrap">
      <div class="search-label">
        Quick Search <span class="search-badge">DATABASE</span>
      </div>
      <div class="search-row">
        <input type="text" id="searchInput" class="search-input" placeholder="e.g. banana, greek yogurt‚Ä¶" onkeydown="if(event.key==='Enter')foodSearch()">
        <button class="search-btn" id="searchBtn" onclick="foodSearch()">
          <span id="searchBtnText">Search</span>
          <div class="search-spinner" id="searchSpinner"></div>
        </button>
      </div>
      <div class="search-results" id="searchResults"></div>
    </div>

    <div class="modal-divider"><span>or enter manually</span></div>

    <div class="form-group">
      <label class="form-label">Food / Meal Name</label>
      <input type="text" id="foodName" class="form-input" placeholder="e.g. Chicken salad, Protein bar‚Ä¶">
    </div>
    <div class="form-group">
      <label class="form-label">Calories</label>
      <input type="number" id="foodCals" class="form-input" placeholder="350" min="0">
    </div>
    <div class="form-group">
      <label class="form-label">Meal Type</label>
      <select id="mealType" class="form-input">
        <option value="Breakfast">üåÖ Breakfast</option>
        <option value="Lunch" selected>‚òÄÔ∏è Lunch</option>
        <option value="Dinner">üåô Dinner</option>
        <option value="Snack">üçé Snack</option>
        <option value="Drink">ü•§ Drink</option>
      </select>
    </div>
    <div class="form-group" id="proteinEntryGroup" style="display:none;">
      <label class="form-label">Protein (g) <span style="color:var(--muted);font-weight:400;text-transform:none;letter-spacing:0;">optional</span></label>
      <input type="number" id="foodProtein" class="form-input" placeholder="e.g. 30" min="0" max="500">
    </div>
    <div class="form-group">
      <label class="form-label">Photo (optional)</label>
      <div class="photo-upload">
        <input type="file" accept="image/*" id="photoInput" onchange="handlePhoto(event)">
        <div id="photoPlaceholder">
          <div class="photo-upload-icon">üì∑</div>
          <div class="photo-upload-text">Tap to add a photo</div>
        </div>
        <img id="photoPreview" class="photo-preview hidden" alt="">
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeAddModal()">Cancel</button>
      <button class="btn-save" onclick="saveEntry()">Log It</button>
    </div>
  </div>
</div>


<!-- =================== EDIT ENTRY MODAL =================== -->
<div class="modal-backdrop" id="editModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <div class="modal-title" style="margin-bottom:0;">Edit Entry</div>
      <button onclick="closeEditModal()" style="background:var(--surface2);border:1px solid var(--border);color:var(--muted);width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;line-height:1;transition:color 0.2s;" onmouseover="this.style.color='var(--text)'" onmouseout="this.style.color='var(--muted)'" title="Close">‚úï</button>
    </div>

    <div class="form-group">
      <label class="form-label">Food / Meal Name</label>
      <input type="text" id="editFoodName" class="form-input" placeholder="e.g. Chicken salad‚Ä¶">
    </div>
    <div class="form-group">
      <label class="form-label">Calories</label>
      <input type="number" id="editFoodCals" class="form-input" placeholder="350" min="0">
    </div>
    <div class="form-group">
      <label class="form-label">Meal Type</label>
      <select id="editMealType" class="form-input">
        <option value="Breakfast">üåÖ Breakfast</option>
        <option value="Lunch">‚òÄÔ∏è Lunch</option>
        <option value="Dinner">üåô Dinner</option>
        <option value="Snack">üçé Snack</option>
        <option value="Drink">ü•§ Drink</option>
      </select>
    </div>
    <div class="form-group" id="editProteinGroup" style="display:none;">
      <label class="form-label">Protein (g) <span style="color:var(--muted);font-weight:400;text-transform:none;letter-spacing:0;">optional</span></label>
      <input type="number" id="editFoodProtein" class="form-input" placeholder="e.g. 30" min="0" max="500">
    </div>
    <div class="form-group">
      <label class="form-label">Photo</label>
      <div class="photo-upload" id="editPhotoUploadBox">
        <input type="file" accept="image/*" id="editPhotoInput" onchange="handleEditPhoto(event)">
        <div id="editPhotoPlaceholder">
          <div class="photo-upload-icon">üì∑</div>
          <div class="photo-upload-text">Tap to add or change photo</div>
        </div>
        <img id="editPhotoPreview" class="photo-preview hidden" alt="">
      </div>
      <button id="editRemovePhotoBtn" onclick="removeEditPhoto()" class="hidden" style="margin-top:8px;background:none;border:none;color:var(--danger);font-family:var(--font-body);font-size:13px;cursor:pointer;padding:0;">‚úï Remove photo</button>
    </div>

    <div class="modal-actions">
      <button class="btn-cancel" onclick="confirmDeleteEntry()" style="flex:1; color:var(--danger); border-color:var(--danger);">Delete</button>
      <button class="btn-save" onclick="saveEditEntry()">Save Changes</button>
    </div>
  </div>
</div>
<div class="modal-backdrop" id="settingsModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <div class="modal-title" style="margin-bottom:0;">Settings</div>
      <button onclick="closeSettings()" style="background:var(--surface2);border:1px solid var(--border);color:var(--muted);width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;line-height:1;transition:color 0.2s;" onmouseover="this.style.color='var(--text)'" onmouseout="this.style.color='var(--muted)'" title="Close">‚úï</button>
    </div>

    <div class="form-group">
      <label class="form-label">My Goal</label>
      <div class="goal-toggle">
        <button class="goal-toggle-btn" id="btnLoss" onclick="setGoalType('loss')">
          <span class="toggle-icon">üìâ</span>
          Weight Loss
        </button>
        <button class="goal-toggle-btn" id="btnGain" onclick="setGoalType('gain')">
          <span class="toggle-icon">üìà</span>
          Weight Gain
        </button>
      </div>
      <div id="goalTypeHint" style="font-size:12px; color:var(--muted); margin-top:10px; min-height:16px;"></div>
    </div>

    <div class="form-group">
      <label class="form-label">Daily Calorie Goal</label>
      <input type="number" id="goalInput" class="form-input" placeholder="e.g. 2000" min="500" max="10000">
      <div style="font-size:12px; color:var(--muted); margin-top:8px;">
        Your goal carries over each day automatically ‚Äî only update it when your needs change.
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Current Weight (lbs)</label>
      <input type="number" id="weightInput" class="form-input" placeholder="e.g. 175" min="50" max="600" step="0.1">
      <div id="weightHint" style="font-size:12px; color:var(--muted); margin-top:8px;">
        Log weekly ‚Äî after 4 weeks or 5 lbs gained, you'll get a reminder to recalculate your calories.
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Goal Weight (lbs)</label>
      <input type="number" id="goalWeightInput" class="form-input" placeholder="e.g. 155" min="50" max="600" step="0.1">
      <div style="font-size:12px; color:var(--muted); margin-top:8px;">
        Used to track your progress and estimate how long it'll take to reach your goal.
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Track Protein?</label>
      <div class="goal-toggle">
        <button class="goal-toggle-btn" id="btnProteinYes" onclick="setProteinTracking(true)">
          <span class="toggle-icon">üí™</span>
          Yes, track it
        </button>
        <button class="goal-toggle-btn" id="btnProteinNo" onclick="setProteinTracking(false)">
          <span class="toggle-icon">‚úñÔ∏è</span>
          No thanks
        </button>
      </div>
    </div>

    <div class="form-group" id="proteinGoalGroup" style="display:none;">
      <label class="form-label">Daily Protein Goal (g)</label>
      <input type="number" id="proteinGoalInput" class="form-input" placeholder="e.g. 150" min="10" max="500">
      <div style="font-size:12px; color:var(--muted); margin-top:8px;">
        A common target is 0.7‚Äì1g per lb of bodyweight.
      </div>
    </div>

    <div class="modal-actions" style="margin-bottom:28px;">
      <button class="btn-save" style="flex:1;" onclick="saveSettings()">Save</button>
    </div>

    <div class="modal-divider"><span>Appearance</span></div>

    <!-- THEME PICKER -->
    <div class="theme-section">
      <div class="theme-group-label">‚ú® Girly</div>
      <div class="theme-grid" id="themeGridGirly"></div>
      <div class="theme-group-label">‚óæ Neutral</div>
      <div class="theme-grid" id="themeGridNeutral"></div>
      <div class="theme-group-label">‚ö° Bold / Masculine</div>
      <div class="theme-grid" id="themeGridMasc"></div>
    </div>

  </div>
</div>


<!-- =================== WEIGHT MODAL =================== -->
<div class="modal-backdrop" id="weightModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Weekly Check-In ‚öñÔ∏è</div>
    <p id="weightModalDesc" style="color:var(--muted); font-size:14px; margin-bottom:20px;">Time to log this week's weight. How are you doing?</p>
    <div class="form-group">
      <label class="form-label">Current Weight (lbs)</label>
      <input type="number" id="weeklyWeightInput" class="form-input" placeholder="e.g. 172" min="50" max="600" step="0.1">
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeWeightModal()">Skip</button>
      <button class="btn-save" onclick="saveWeeklyWeight()">Log Weight</button>
    </div>
  </div>
</div>


<script>
// ============================
// THEME DEFINITIONS
// ============================
const THEMES = {
  girly: [
    { id: 'rose',     name: 'Rose',     dots: ['#fff5f7','#e8557a','#c4389e'] },
    { id: 'lavender', name: 'Lavender', dots: ['#f7f4ff','#9b6fe8','#e07ab8'] },
    { id: 'peach',    name: 'Peach',    dots: ['#fff8f4','#e87a47','#e84778'] },
  ],
  neutral: [
    { id: 'default',  name: 'Dark Coal', dots: ['#0f0e0d','#e8c547','#e07a3a'] },
    { id: 'light',    name: 'Linen',     dots: ['#f5f4f2','#5a7a5a','#8a6a3a'] },
    { id: 'cream',    name: 'Cream',     dots: ['#faf7f0','#8a7a5a','#c07850'] },
    { id: 'slate',    name: 'Slate',     dots: ['#1e2228','#64b8e8','#e8a830'] },
    { id: 'cream',    name: 'Cream',     dots: ['#faf7f0','#8a7a5a','#c07850'] },
  ],
  masc: [
    { id: 'carbon',   name: 'Carbon',   dots: ['#111214','#00d4aa','#ff6b35'] },
    { id: 'navy',     name: 'Navy Ops', dots: ['#0a0f1e','#e8b847','#4a9fe8'] },
    { id: 'gunmetal', name: 'Gunmetal', dots: ['#1c1c1c','#e84040','#e88040'] },
  ],
};

// ============================
// STORAGE HELPERS
// ============================
function gs(k, d) { try { const v = localStorage.getItem(k); return v !== null ? JSON.parse(v) : d; } catch { return d; } }
function ss(k, v) { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} }

// ============================
// STATE
// ============================
let settings         = gs('fuel_settings', { goal: 0, startWeight: 0, currentWeight: 0, settingsDate: null, goalType: 'loss', trackProtein: false, proteinGoal: 0, goalWeight: 0 });
let allDays          = gs('fuel_days', {});
let weightLog        = gs('fuel_weights', []);
let lastWeightPrompt = gs('fuel_last_weight_prompt', null);
let currentTheme     = gs('fuel_theme', 'default');
let photoDataUrl     = null;

const DAYS_SHORT = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const DAYS_LONG  = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const MONTHS     = ['January','February','March','April','May','June','July','August','September','October','November','December'];

function todayKey() { const d = new Date(); return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; }
const tk = todayKey();
if (!allDays[tk]) { allDays[tk] = { entries: [], goal: settings.goal || 0, note: '' }; ss('fuel_days', allDays); }
// Always sync today's goal from settings (in case it was set on a previous day)
if (settings.goal && !allDays[tk].goal) { allDays[tk].goal = settings.goal; ss('fuel_days', allDays); }
if (!allDays[tk].note) allDays[tk].note = '';

// ============================
// THEME
// ============================
function applyTheme(id) {
  document.documentElement.setAttribute('data-theme', id === 'default' ? '' : id);
  currentTheme = id;
  ss('fuel_theme', id);
  // refresh swatch active states
  document.querySelectorAll('.theme-swatch').forEach(s => {
    s.classList.toggle('active', s.dataset.themeId === id);
  });
}

function buildThemeSwatches() {
  const groups = { girly: 'themeGridGirly', neutral: 'themeGridNeutral', masc: 'themeGridMasc' };
  // dedupe neutral
  const seen = new Set();
  Object.entries(groups).forEach(([key, gridId]) => {
    const grid = document.getElementById(gridId);
    const list = key === 'neutral'
      ? THEMES.neutral.filter(t => { if (seen.has(t.id)) return false; seen.add(t.id); return true; })
      : THEMES[key];
    list.forEach(t => {
      const sw = document.createElement('div');
      sw.className = 'theme-swatch' + (t.id === currentTheme ? ' active' : '');
      sw.dataset.themeId = t.id;
      sw.style.background = t.dots[0];
      sw.style.border = `2px solid ${t.dots[1]}44`;
      sw.innerHTML = `
        <div class="swatch-dots">
          ${t.dots.map(c => `<div class="swatch-dot" style="background:${c}"></div>`).join('')}
        </div>
        <div class="swatch-name" style="color:${t.dots[1]}">${t.name}</div>
      `;
      sw.onclick = () => applyTheme(t.id);
      grid.appendChild(sw);
    });
  });
}

// ============================
// HEADER
// ============================
function renderHeader() {
  const d = new Date();
  document.getElementById('dateDisplay').textContent = `${MONTHS[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
  document.getElementById('dayDisplay').textContent = DAYS_LONG[d.getDay()];
}

// ============================
// RING
// ============================
function renderRing() {
  const today    = allDays[tk];
  const goal     = settings.goal || 0;
  const consumed = today.entries.reduce((s, e) => s + e.cals, 0);
  const remaining = goal - consumed;
  const isLoss   = (settings.goalType || 'loss') === 'loss';

  // Bottom stat label: "Remaining" for loss, "Goal" for gain
  document.getElementById('goalStatLbl').textContent = isLoss ? 'Remaining' : 'Goal';
  document.getElementById('goalDisplay').textContent  = isLoss ? (goal ? remaining : '‚Äî') : (goal || '‚Äî');

  document.getElementById('consumedDisplay').textContent = consumed;
  document.getElementById('mealsDisplay').textContent    = today.entries.length;

  // Ring center: always show remaining for loss, consumed for gain
  const ringNum = isLoss ? remaining : consumed;
  document.getElementById('remainingCals').textContent   = goal ? ringNum : '‚Äî';
  document.getElementById('ringCenterLabel').textContent = isLoss ? 'remaining' : 'consumed';

  const ring = document.getElementById('ringFill');
  const circ = 477.5;
  if (goal > 0) {
    const pct = Math.min(consumed / goal, 1);
    ring.style.strokeDashoffset = circ - circ * pct;
    if (isLoss) {
      ring.style.stroke = pct >= 1 ? 'var(--danger)' : pct > 0.85 ? 'var(--accent2)' : 'var(--accent)';
      document.getElementById('remainingCals').style.color = remaining < 0 ? 'var(--danger)' : 'var(--text)';
    } else {
      ring.style.stroke = pct >= 1 ? 'var(--good)' : 'var(--accent)';
      document.getElementById('remainingCals').style.color = 'var(--text)';
    }
  } else {
    ring.style.strokeDashoffset = circ;
    ring.style.stroke = 'var(--accent)';
  }
  document.getElementById('setupBanner').classList.toggle('hidden', goal > 0);
}

// ============================
// PROTEIN BAR
// ============================
function renderProtein() {
  const section = document.getElementById('proteinSection');
  const trackProtein = settings.trackProtein && settings.proteinGoal > 0;
  section.classList.toggle('visible', trackProtein);
  // Also show/hide protein entry field in add modal
  document.getElementById('proteinEntryGroup').style.display = trackProtein ? 'block' : 'none';
  if (!trackProtein) return;

  const consumed = allDays[tk].entries.reduce((s, e) => s + (e.protein || 0), 0);
  const goal     = settings.proteinGoal;
  const pct      = goal > 0 ? Math.min(consumed / goal * 100, 100) : 0;

  document.getElementById('proteinConsumed').textContent   = consumed;
  document.getElementById('proteinGoalDisplay').textContent = goal;
  const fill = document.getElementById('proteinFill');
  fill.style.width = pct + '%';
  fill.classList.toggle('over', consumed >= goal);
}

// ============================
// WEEK CHART
// ============================
function renderWeekChart() {
  const container = document.getElementById('weekDays');
  container.innerHTML = '';
  const today = new Date();
  const todayDow = today.getDay();
  for (let i = 0; i < 7; i++) {
    const d = new Date(today);
    d.setDate(today.getDate() - todayDow + i);
    const key = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
    const dayData = allDays[key];
    const goal = settings.goal || 2000;
    const consumed = dayData ? dayData.entries.reduce((s, e) => s + e.cals, 0) : 0;
    const pct = goal > 0 ? Math.min(consumed / goal, 1) * 100 : 0;
    const isToday = i === todayDow;
    const isFuture = d > today && !isToday;
    const col = document.createElement('div');
    col.className = 'week-day';
    col.innerHTML = `
      <div class="week-day-label">${DAYS_SHORT[i]}</div>
      <div class="week-day-bar" title="${consumed} / ${goal} kcal">
        <div class="week-day-fill${consumed > goal ? ' over' : ''}${isToday ? ' today' : ''}"
          style="height:${isFuture ? 0 : pct}%"></div>
      </div>
      <div class="week-day-dot${isToday ? ' today' : ''}"></div>
    `;
    container.appendChild(col);
  }
}

// ============================
// ENTRIES
// ============================
const MEAL_EMOJI = { Breakfast:'üåÖ', Lunch:'‚òÄÔ∏è', Dinner:'üåô', Snack:'üçé', Drink:'ü•§' };

function renderEntries() {
  const list = document.getElementById('entriesList');
  list.querySelectorAll('.entry-card').forEach(c => c.remove());
  const entries = allDays[tk].entries;
  document.getElementById('emptyState').classList.toggle('hidden', entries.length > 0);
  entries.forEach((e, i) => {
    const card = document.createElement('div');
    card.className = 'entry-card';
    card.innerHTML = `
      <div class="entry-img">${e.photo ? `<img src="${e.photo}" alt="${esc(e.name)}">` : (MEAL_EMOJI[e.mealType] || 'üç¥')}</div>
      <div class="entry-info">
        <div class="entry-name">${esc(e.name)}</div>
        <div class="entry-meta">
          <span class="entry-tag ${e.mealType||''}">${e.mealType||'Meal'}</span>
          <span>${e.time}</span>
        </div>
      </div>
      <div class="entry-cals">${e.cals}</div>
      <button class="entry-edit" onclick="openEditModal(${i})" title="Edit">Edit</button>
    `;
    list.appendChild(card);
  });
}

function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function deleteEntry(i) { allDays[tk].entries.splice(i,1); ss('fuel_days',allDays); renderAll(); }

// ============================
// EDIT ENTRY MODAL
// ============================
let editingIndex = -1;
let editPhotoDataUrl = null;

function openEditModal(i) {
  const e = allDays[tk].entries[i];
  editingIndex = i;
  editPhotoDataUrl = e.photo || null;

  document.getElementById('editFoodName').value    = e.name || '';
  document.getElementById('editFoodCals').value    = e.cals || '';
  document.getElementById('editMealType').value    = e.mealType || 'Lunch';
  document.getElementById('editFoodProtein').value = e.protein || '';

  // Protein field visibility
  const trackProtein = settings.trackProtein && settings.proteinGoal > 0;
  document.getElementById('editProteinGroup').style.display = trackProtein ? 'block' : 'none';

  // Photo
  if (e.photo) {
    document.getElementById('editPhotoPreview').src = e.photo;
    document.getElementById('editPhotoPreview').classList.remove('hidden');
    document.getElementById('editPhotoPlaceholder').classList.add('hidden');
    document.getElementById('editRemovePhotoBtn').classList.remove('hidden');
  } else {
    document.getElementById('editPhotoPreview').classList.add('hidden');
    document.getElementById('editPhotoPlaceholder').classList.remove('hidden');
    document.getElementById('editRemovePhotoBtn').classList.add('hidden');
  }

  document.getElementById('editModal').classList.add('open');
}

function closeEditModal() {
  document.getElementById('editModal').classList.remove('open');
  editingIndex = -1;
  editPhotoDataUrl = null;
}

function handleEditPhoto(e) {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    editPhotoDataUrl = ev.target.result;
    document.getElementById('editPhotoPreview').src = editPhotoDataUrl;
    document.getElementById('editPhotoPreview').classList.remove('hidden');
    document.getElementById('editPhotoPlaceholder').classList.add('hidden');
    document.getElementById('editRemovePhotoBtn').classList.remove('hidden');
  };
  reader.readAsDataURL(file);
}

function removeEditPhoto() {
  editPhotoDataUrl = null;
  document.getElementById('editPhotoPreview').classList.add('hidden');
  document.getElementById('editPhotoPlaceholder').classList.remove('hidden');
  document.getElementById('editRemovePhotoBtn').classList.add('hidden');
  document.getElementById('editPhotoInput').value = '';
}

function saveEditEntry() {
  const name     = document.getElementById('editFoodName').value.trim();
  const cals     = parseInt(document.getElementById('editFoodCals').value);
  const mealType = document.getElementById('editMealType').value;
  const protein  = parseInt(document.getElementById('editFoodProtein').value) || 0;

  if (!name)           { alert('Please enter a food name.'); return; }
  if (!cals || cals<0) { alert('Please enter valid calories.'); return; }

  const entry = allDays[tk].entries[editingIndex];
  entry.name     = name;
  entry.cals     = cals;
  entry.mealType = mealType;
  entry.protein  = protein;
  entry.photo    = editPhotoDataUrl;

  ss('fuel_days', allDays);
  closeEditModal();
  renderAll();
}

function confirmDeleteEntry() {
  if (confirm('Remove this entry?')) {
    deleteEntry(editingIndex);
    closeEditModal();
  }
}

// ============================
// NOTES
// ============================
function renderNote() { document.getElementById('dailyNote').value = allDays[tk].note || ''; }
function saveNote() { allDays[tk].note = document.getElementById('dailyNote').value; ss('fuel_days', allDays); }

// ============================
// FOOD SEARCH (Open Food Facts)
// ============================
async function foodSearch() {
  const query = document.getElementById('searchInput').value.trim();
  if (!query) return;

  const btn     = document.getElementById('searchBtn');
  const btnText = document.getElementById('searchBtnText');
  const spinner = document.getElementById('searchSpinner');
  const results = document.getElementById('searchResults');

  btn.disabled = true;
  btnText.style.display = 'none';
  spinner.style.display = 'block';
  results.classList.add('visible');
  results.innerHTML = `<div class="search-msg">Searching‚Ä¶</div>`;

  try {
    // Search Open Food Facts ‚Äî broad fields, larger page to get more candidates
    const url = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&action=process&json=1&page_size=20&fields=product_name,brands,nutriments,serving_size,serving_quantity,categories_tags`;
    const resp = await fetch(url);
    if (!resp.ok) throw new Error('Network error');
    const data = await resp.json();

    const products = (data.products || []);

    // Pull calories from every possible field name OFF uses
    const getCals = (n, type) => {
      if (type === 'serving') {
        return n['energy-kcal_serving'] || n['energy-kcal_serve'] ||
               (n['energy-kcal'] && n['serving_quantity'] ? n['energy-kcal'] * n['serving_quantity'] / 100 : 0) || 0;
      }
      return n['energy-kcal_100g'] || n['energy-kcal'] ||
             (n['energy_100g'] ? n['energy_100g'] / 4.184 : 0) || 0;
    };
    const getMacro = (n, macro, type) => {
      const sfx = type === 'serving' ? '_serving' : '_100g';
      return n[macro + sfx] || n[macro] || 0;
    };

    // Filter: must have a name AND any calorie data
    const valid = products.filter(p => {
      if (!p.product_name || !p.product_name.trim()) return false;
      const n = p.nutriments || {};
      return getCals(n, 'serving') > 0 || getCals(n, '100g') > 0;
    });

    if (!valid.length) {
      results.innerHTML = `<div class="search-msg">No results for "<strong>${esc(query)}</strong>" ‚Äî try simpler terms like "chicken" or "oats".</div>`;
      return;
    }

    // Map to clean items ‚Äî dedupe by name+cals
    const seen = new Set();
    const items = [];
    for (const p of valid) {
      const n = p.nutriments || {};
      const hasServing = getCals(n, 'serving') >= 1;
      const cals    = Math.round(hasServing ? getCals(n, 'serving')             : getCals(n, '100g'));
      const protein = Math.round(hasServing ? getMacro(n,'proteins','serving')  : getMacro(n,'proteins','100g'));
      const carbs   = Math.round(hasServing ? getMacro(n,'carbohydrates','serving') : getMacro(n,'carbohydrates','100g'));
      const fat     = Math.round(hasServing ? getMacro(n,'fat','serving')       : getMacro(n,'fat','100g'));
      if (cals <= 0) continue;

      const brand   = p.brands ? p.brands.split(',')[0].trim() : '';
      const note    = hasServing ? (p.serving_size || 'per serving') : 'per 100g';
      const name    = p.product_name.trim();
      const key     = `${name.toLowerCase()}|${cals}`;
      if (seen.has(key)) continue;
      seen.add(key);

      items.push({ name, brand, cals, protein, carbs, fat, note });
      if (items.length >= 6) break;
    }

    if (!items.length) {
      results.innerHTML = `<div class="search-msg">No usable nutrition data found ‚Äî try a different search.</div>`;
      return;
    }

    results.innerHTML = '';
    items.forEach(item => {
      const div = document.createElement('div');
      div.className = 'search-result-item';
      div.onclick = () => useSearchResult(item);
      div.innerHTML = `
        <div style="flex:1;min-width:0;">
          <div class="search-result-name">${esc(item.name)}</div>
          <div class="search-result-sub">${item.brand ? esc(item.brand) + ' ¬∑ ' : ''}P ${item.protein}g ¬∑ C ${item.carbs}g ¬∑ F ${item.fat}g ¬∑ ${esc(item.note)}</div>
        </div>
        <div class="search-result-right">
          <div class="search-result-cals">${item.cals}</div>
          <div class="search-result-use">Use ‚Üë</div>
        </div>`;
      results.appendChild(div);
    });

  } catch (err) {
    results.innerHTML = `<div class="search-msg" style="color:var(--danger);">Search failed ‚Äî check your connection and try again.</div>`;
  } finally {
    btn.disabled = false;
    btnText.style.display = 'inline';
    spinner.style.display = 'none';
  }
}

function useSearchResult(item) {
  document.getElementById('foodName').value    = item.name + (item.brand ? ` (${item.brand})` : '');
  document.getElementById('foodCals').value    = item.cals;
  if (settings.trackProtein) document.getElementById('foodProtein').value = item.protein || '';
  document.getElementById('searchResults').classList.remove('visible');
  document.getElementById('searchInput').value = '';
  document.getElementById('foodName').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// ============================
// ADD FOOD MODAL
// ============================
function openAddModal() {
  document.getElementById('foodName').value    = '';
  document.getElementById('foodCals').value    = '';
  document.getElementById('foodProtein').value = '';
  document.getElementById('searchInput').value = '';
  document.getElementById('searchResults').classList.remove('visible');
  document.getElementById('searchResults').innerHTML = '';
  document.getElementById('photoPreview').classList.add('hidden');
  document.getElementById('photoPlaceholder').classList.remove('hidden');
  photoDataUrl = null;
  const h = new Date().getHours();
  document.getElementById('mealType').value = h < 10 ? 'Breakfast' : h < 14 ? 'Lunch' : h < 18 ? 'Dinner' : 'Snack';
  document.getElementById('addModal').classList.add('open');
}
function closeAddModal() { document.getElementById('addModal').classList.remove('open'); }

function handlePhoto(e) {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    photoDataUrl = ev.target.result;
    document.getElementById('photoPreview').src = photoDataUrl;
    document.getElementById('photoPreview').classList.remove('hidden');
    document.getElementById('photoPlaceholder').classList.add('hidden');
  };
  reader.readAsDataURL(file);
}

function saveEntry() {
  const name     = document.getElementById('foodName').value.trim();
  const cals     = parseInt(document.getElementById('foodCals').value);
  const mealType = document.getElementById('mealType').value;
  const protein  = parseInt(document.getElementById('foodProtein').value) || 0;
  if (!name)          { alert('Please enter a food name.'); return; }
  if (!cals || cals<0){ alert('Please enter valid calories.'); return; }
  const time = new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
  allDays[tk].entries.push({ name, cals, protein, mealType, time, photo: photoDataUrl || null });
  ss('fuel_days', allDays);
  closeAddModal();
  renderAll();
}



// ============================
// GOAL TYPE
// ============================
function setGoalType(type) {
  settings.goalType = type;
  document.getElementById('btnLoss').classList.toggle('active', type === 'loss');
  document.getElementById('btnGain').classList.toggle('active', type === 'gain');
  const hint = document.getElementById('goalTypeHint');
  const weightHint = document.getElementById('weightHint');
  if (type === 'loss') {
    hint.textContent = 'üî• Eating below your TDEE helps create a calorie deficit for fat loss.';
    weightHint.textContent = 'Log weekly ‚Äî after 4 weeks or 5 lbs lost, you\'ll get a reminder to recalculate.';
  } else {
    hint.textContent = 'üí™ Eating above your TDEE fuels muscle growth and healthy weight gain.';
    weightHint.textContent = 'Log weekly ‚Äî after 4 weeks or 5 lbs gained, you\'ll get a reminder to recalculate.';
  }
}

// ============================
// PROTEIN TRACKING
// ============================
function setProteinTracking(val) {
  settings.trackProtein = val;
  document.getElementById('btnProteinYes').classList.toggle('active', val);
  document.getElementById('btnProteinNo').classList.toggle('active', !val);
  document.getElementById('proteinGoalGroup').style.display = val ? 'block' : 'none';
}

// ============================
// SETTINGS MODAL
// ============================
function openSettings() {
  document.getElementById('goalInput').value        = settings.goal || '';
  document.getElementById('weightInput').value      = settings.currentWeight || '';
  document.getElementById('goalWeightInput').value  = settings.goalWeight || '';
  document.getElementById('proteinGoalInput').value = settings.proteinGoal || '';
  setGoalType(settings.goalType || 'loss');
  setProteinTracking(settings.trackProtein || false);
  // refresh active swatches
  document.querySelectorAll('.theme-swatch').forEach(s => {
    s.classList.toggle('active', s.dataset.themeId === currentTheme);
  });
  document.getElementById('settingsModal').classList.add('open');
}
function closeSettings() { document.getElementById('settingsModal').classList.remove('open'); }

function saveSettings() {
  const goal         = parseInt(document.getElementById('goalInput').value);
  const weight       = parseFloat(document.getElementById('weightInput').value);
  const proteinGoal  = parseInt(document.getElementById('proteinGoalInput').value);
  const goalWeight   = parseFloat(document.getElementById('goalWeightInput').value);

  if (goal && goal > 0) settings.goal = goal;
  allDays[tk].goal = settings.goal || 0;

  if (proteinGoal && proteinGoal > 0) settings.proteinGoal = proteinGoal;
  if (goalWeight && goalWeight > 0)   settings.goalWeight  = goalWeight;

  if (weight && weight > 0) {
    if (!settings.startWeight) settings.startWeight = weight;
    settings.currentWeight = weight;
    settings.settingsDate  = new Date().toISOString();
    weightLog.push({ date: new Date().toISOString(), weight });
    ss('fuel_weights', weightLog);
    ss('fuel_last_weight_prompt', new Date().toISOString());
    lastWeightPrompt = new Date().toISOString();
  }
  ss('fuel_settings', settings);
  ss('fuel_days', allDays);
  closeSettings();
  renderAll();
}

// ============================
// WEIGHT MODAL
// ============================
function openWeightModal() {
  const isGain = settings.goalType === 'gain';
  document.getElementById('weeklyWeightInput').value = '';
  document.getElementById('weightModalDesc').textContent = isGain
    ? 'Time to log this week\'s weight. Keep fueling those gains! üí™'
    : 'Time to log this week\'s weight. Stay consistent ‚Äî you\'ve got this! üî•';
  document.getElementById('weightModal').classList.add('open');
}
function closeWeightModal() {
  document.getElementById('weightModal').classList.remove('open');
  ss('fuel_last_weight_prompt', new Date().toISOString());
  lastWeightPrompt = new Date().toISOString();
}
function saveWeeklyWeight() {
  const weight = parseFloat(document.getElementById('weeklyWeightInput').value);
  if (!weight || weight <= 0) { alert('Please enter a valid weight.'); return; }
  settings.currentWeight = weight;
  if (!settings.startWeight) settings.startWeight = weight;
  weightLog.push({ date: new Date().toISOString(), weight });
  ss('fuel_weights', weightLog);
  ss('fuel_settings', settings);
  ss('fuel_last_weight_prompt', new Date().toISOString());
  lastWeightPrompt = new Date().toISOString();
  document.getElementById('weightModal').classList.remove('open');
  renderAll();
}

// ============================
// NOTIFICATIONS
// ============================
function renderNotifications() {
  const container = document.getElementById('notifications');
  container.innerHTML = '';
  if (!settings.goal) return;
  if (checkWeightPrompt()) {
    const bar = document.createElement('div');
    bar.className = 'notification-bar';
    bar.innerHTML = `
      <div class="notif-icon">‚öñÔ∏è</div>
      <div class="notif-text"><strong>Weekly weigh-in</strong><span>Time to log your weight for this week</span></div>
      <button class="notif-btn" onclick="openWeightModal()">Log</button>`;
    container.appendChild(bar);
  }
  const recalc = checkRecalcSuggestion();
  if (recalc) {
    const bar = document.createElement('div');
    bar.className = 'notification-bar warning';
    bar.innerHTML = `
      <div class="notif-icon">üîÑ</div>
      <div class="notif-text"><strong>Recalculate your calories</strong><span>${recalc}</span></div>
      <button class="notif-btn" onclick="openSettings(); dismissRecalc();">Update</button>`;
    container.appendChild(bar);
  }
}

function checkWeightPrompt() {
  if (!settings.goal) return false;
  if (!lastWeightPrompt) return true;
  return (new Date() - new Date(lastWeightPrompt)) / (1000*60*60*24) >= 7;
}
function checkRecalcSuggestion() {
  if (!settings.startWeight || !settings.currentWeight || !settings.settingsDate) return false;
  const change = settings.currentWeight - settings.startWeight; // positive = gained, negative = lost
  const weeks  = (new Date() - new Date(settings.settingsDate)) / (1000*60*60*24*7);
  const isGain = settings.goalType === 'gain';

  if (isGain) {
    if (change >= 5)  return `You've gained ${change.toFixed(1)} lbs ‚Äî great progress! Update your goal to keep growing.`;
    if (weeks >= 4)   return `It's been ${Math.floor(weeks)} weeks ‚Äî recalculate to keep making gains.`;
  } else {
    if (-change >= 5) return `You've lost ${(-change).toFixed(1)} lbs ‚Äî amazing! Update your goal to keep the momentum.`;
    if (weeks >= 4)   return `It's been ${Math.floor(weeks)} weeks ‚Äî recalculate for best results.`;
  }
  return false;
}
function dismissRecalc() {
  settings.settingsDate = new Date().toISOString();
  settings.startWeight  = settings.currentWeight;
  ss('fuel_settings', settings);
}

// ============================
// PROGRESS MODAL
// ============================
function openProgress() {
  renderProgressModal();
  document.getElementById('progressModal').classList.add('open');
}
function closeProgress() {
  document.getElementById('progressModal').classList.remove('open');
}

function renderProgressModal() {
  const isGain      = settings.goalType === 'gain';
  const startW      = settings.startWeight;
  const currentW    = settings.currentWeight;
  const goalW       = settings.goalWeight;
  const logs        = weightLog.slice().sort((a,b) => new Date(a.date) - new Date(b.date));
  const hasData     = startW > 0 && currentW > 0;
  const hasGoal     = goalW > 0;

  // ---- SHOW/HIDE sections ----
  document.getElementById('progressNoData').style.display     = hasData ? 'none' : 'block';
  document.getElementById('progressGoalSection').style.display = (hasData && hasGoal) ? 'block' : 'none';
  document.getElementById('progressStatsRow').style.display    = hasData && logs.length > 1 ? 'grid' : 'none';
  document.getElementById('progressSuggestions').style.display = hasData ? 'block' : 'none';

  if (!hasData) return;

  // ---- GOAL PROGRESS BAR ----
  if (hasGoal) {
    const totalNeeded = Math.abs(goalW - startW);
    const achieved    = isGain
      ? Math.max(0, currentW - startW)
      : Math.max(0, startW - currentW);
    const pct = totalNeeded > 0 ? Math.min(achieved / totalNeeded * 100, 100) : 0;
    const remaining = Math.abs(goalW - currentW);

    document.getElementById('progressGoalBar').style.width   = pct.toFixed(1) + '%';
    document.getElementById('progressGoalPct').textContent   = pct.toFixed(0) + '% there';
    document.getElementById('progressStartLbl').textContent   = startW + ' lbs';
    document.getElementById('progressCurrentLbl').textContent = currentW + ' lbs';
    document.getElementById('progressGoalLbl').textContent    = goalW + ' lbs';

    // ETA estimate ‚Äî 1 lb/week loss or gain pace
    const avgWeeklyChange = calcAvgWeeklyChange(logs);
    const etaBox = document.getElementById('progressEtaBox');
    if (remaining < 0.5) {
      etaBox.innerHTML = `üéâ <strong>You've reached your goal weight!</strong> Amazing work ‚Äî update your goal to keep progressing.`;
    } else if (Math.abs(avgWeeklyChange) >= 0.1) {
      const weeksLeft = remaining / Math.abs(avgWeeklyChange);
      const etaDate   = new Date();
      etaDate.setDate(etaDate.getDate() + Math.round(weeksLeft * 7));
      const etaStr    = etaDate.toLocaleDateString(undefined, { month:'long', day:'numeric', year:'numeric' });
      etaBox.innerHTML = `üìÖ At your current pace of <strong>${Math.abs(avgWeeklyChange).toFixed(1)} lbs/week</strong>, you'll reach your goal around <strong>${etaStr}</strong> ‚Äî about <strong>${Math.round(weeksLeft)} weeks</strong> away.`;
    } else {
      etaBox.innerHTML = `üìä Keep logging your weight weekly ‚Äî we'll estimate your goal date once we have more data.`;
    }
  }

  // ---- WEIGHT CHART ----
  drawWeightChart(logs, goalW, isGain);

  // ---- STATS ROW ----
  if (logs.length > 1) {
    const first     = logs[0].weight;
    const last      = logs[logs.length - 1].weight;
    const change    = last - first;
    const msElapsed = new Date(logs[logs.length-1].date) - new Date(logs[0].date);
    const weeksElapsed = msElapsed / (1000*60*60*24*7);
    const avgWeekly = weeksElapsed > 0 ? Math.abs(change / weeksElapsed) : 0;

    const dir = change >= 0 ? '+' : '';
    document.getElementById('statChange').textContent     = dir + change.toFixed(1) + ' lbs';
    document.getElementById('statChange').style.color     = isGain ? (change > 0 ? 'var(--good)' : 'var(--danger)') : (change < 0 ? 'var(--good)' : 'var(--danger)');
    document.getElementById('statChangeLbl').textContent  = isGain ? 'Gained' : 'Lost';
    document.getElementById('statWeeks').textContent      = Math.round(weeksElapsed) || '< 1';
    document.getElementById('statAvgWeekly').textContent  = avgWeekly.toFixed(1) + ' lbs';
  }

  // ---- SUGGESTIONS ----
  renderSuggestions(isGain, currentW, goalW, startW, logs);
}

function calcAvgWeeklyChange(logs) {
  if (logs.length < 2) return 0;
  const first = logs[0]; const last = logs[logs.length-1];
  const weeks = (new Date(last.date) - new Date(first.date)) / (1000*60*60*24*7);
  return weeks > 0 ? (last.weight - first.weight) / weeks : 0;
}

function drawWeightChart(logs, goalW, isGain) {
  const canvas = document.getElementById('weightChart');
  const empty  = document.getElementById('weightChartEmpty');
  const ctx    = canvas.getContext('2d');

  if (logs.length < 2) {
    canvas.style.display = 'none';
    empty.style.display = 'flex';
    return;
  }
  canvas.style.display = 'block';
  empty.style.display  = 'none';

  // Size canvas to device pixel ratio
  const wrap  = document.getElementById('weightChartWrap');
  const dpr   = window.devicePixelRatio || 1;
  const W     = wrap.clientWidth;
  const H     = 160;
  canvas.width  = W * dpr;
  canvas.height = H * dpr;
  canvas.style.width  = W + 'px';
  canvas.style.height = H + 'px';
  ctx.scale(dpr, dpr);

  const weights = logs.map(l => l.weight);
  const allVals = goalW > 0 ? [...weights, goalW] : weights;
  const minW    = Math.min(...allVals) - 3;
  const maxW    = Math.max(...allVals) + 3;
  const pad     = { top: 16, right: 20, bottom: 28, left: 36 };
  const cW      = W - pad.left - pad.right;
  const cH      = H - pad.top  - pad.bottom;

  const xScale = i  => pad.left + (i / (logs.length - 1)) * cW;
  const yScale = v  => pad.top  + (1 - (v - minW) / (maxW - minW)) * cH;

  // CSS variable colours ‚Äî read from :root
  const style    = getComputedStyle(document.documentElement);
  const accent   = style.getPropertyValue('--accent').trim()   || '#e8c547';
  const good     = style.getPropertyValue('--good').trim()     || '#5ab88a';
  const muted    = style.getPropertyValue('--muted').trim()    || '#7a7672';
  const surface2 = style.getPropertyValue('--surface2').trim() || '#232220';
  const text     = style.getPropertyValue('--text').trim()     || '#f0ede8';

  ctx.clearRect(0, 0, W, H);

  // Gridlines
  ctx.strokeStyle = surface2; ctx.lineWidth = 1;
  for (let i = 0; i <= 3; i++) {
    const y = pad.top + (cH / 3) * i;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(pad.left + cW, y); ctx.stroke();
    const val = maxW - ((maxW - minW) / 3) * i;
    ctx.fillStyle = muted; ctx.font = `10px sans-serif`; ctx.textAlign = 'right';
    ctx.fillText(val.toFixed(0), pad.left - 4, y + 3);
  }

  // Goal weight dashed line
  if (goalW > 0 && goalW >= minW && goalW <= maxW) {
    const gy = yScale(goalW);
    ctx.strokeStyle = good; ctx.lineWidth = 1.5;
    ctx.setLineDash([4, 4]);
    ctx.beginPath(); ctx.moveTo(pad.left, gy); ctx.lineTo(pad.left + cW, gy); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = good; ctx.font = 'bold 10px sans-serif'; ctx.textAlign = 'left';
    ctx.fillText('Goal', pad.left + 4, gy - 3);
  }

  // Area fill under line
  const grad = ctx.createLinearGradient(0, pad.top, 0, pad.top + cH);
  grad.addColorStop(0, accent + '55');
  grad.addColorStop(1, accent + '05');
  ctx.beginPath();
  ctx.moveTo(xScale(0), yScale(weights[0]));
  weights.forEach((w, i) => { if (i > 0) ctx.lineTo(xScale(i), yScale(w)); });
  ctx.lineTo(xScale(weights.length-1), pad.top + cH);
  ctx.lineTo(xScale(0), pad.top + cH);
  ctx.closePath();
  ctx.fillStyle = grad; ctx.fill();

  // Main line
  ctx.beginPath();
  ctx.strokeStyle = accent; ctx.lineWidth = 2.5; ctx.lineJoin = 'round';
  weights.forEach((w, i) => {
    i === 0 ? ctx.moveTo(xScale(i), yScale(w)) : ctx.lineTo(xScale(i), yScale(w));
  });
  ctx.stroke();

  // Dots + labels
  weights.forEach((w, i) => {
    const x = xScale(i); const y = yScale(w);
    ctx.beginPath(); ctx.arc(x, y, 4, 0, Math.PI * 2);
    ctx.fillStyle = accent; ctx.fill();
    ctx.strokeStyle = surface2; ctx.lineWidth = 1.5; ctx.stroke();
  });

  // X-axis date labels (first, middle, last)
  const labelIdxs = [0, Math.floor((logs.length-1)/2), logs.length-1].filter((v,i,a) => a.indexOf(v) === i);
  ctx.fillStyle = muted; ctx.font = '10px sans-serif'; ctx.textAlign = 'center';
  labelIdxs.forEach(i => {
    const d = new Date(logs[i].date);
    const lbl = `${d.getMonth()+1}/${d.getDate()}`;
    ctx.fillText(lbl, xScale(i), H - 6);
  });
}

function renderSuggestions(isGain, currentW, goalW, startW, logs) {
  const list    = document.getElementById('suggestionsList');
  list.innerHTML = '';
  const avgWeekly  = calcAvgWeeklyChange(logs);
  const goal       = settings.goal || 0;
  const remaining  = goalW > 0 ? Math.abs(goalW - currentW) : null;
  const tips       = [];

  if (isGain) {
    // ---- GAIN TIPS ----
    if (avgWeekly < 0.25 && logs.length >= 2) tips.push({
      icon: 'üìà', hl: true,
      title: 'You may need a bigger surplus',
      text: `You're gaining less than 0.25 lbs/week. Try adding 150‚Äì200 more calories per day ‚Äî focus on protein-rich foods to maximize muscle over fat.`
    });
    if (avgWeekly > 1 && logs.length >= 2) tips.push({
      icon: '‚ö†Ô∏è', hl: false,
      title: 'Gaining faster than ideal',
      text: `Above ~0.5‚Äì1 lbs/week may mean more fat gain than muscle. Consider reducing your surplus by 200 cal and increasing resistance training.`
    });
    if (goal > 0) tips.push({
      icon: 'üçó', hl: false,
      title: 'Prioritize protein',
      text: `For muscle gain, aim for 0.8‚Äì1g of protein per lb of bodyweight (${Math.round((currentW || 150) * 0.9)}g/day). Distribute it across every meal.`
    });
    tips.push({
      icon: 'üèãÔ∏è', hl: false,
      title: 'Resistance training is key',
      text: 'A calorie surplus without strength training leads to fat gain. Lift 3‚Äì4x per week and progressively overload each session.'
    });
    if (remaining !== null && remaining > 0) tips.push({
      icon: 'üìÖ', hl: false,
      title: 'Pace yourself',
      text: `You have ${remaining.toFixed(1)} lbs to go. At a healthy pace of 0.5 lbs/week that's about ${Math.ceil(remaining / 0.5)} weeks ‚Äî stay consistent over rushing.`
    });
  } else {
    // ---- LOSS TIPS ----
    if (avgWeekly < 0.25 && logs.length >= 2 && (startW - currentW) < 1) tips.push({
      icon: 'üî•', hl: true,
      title: "Scale isn't moving much yet",
      text: `Less than 0.25 lbs/week progress. Try reducing daily intake by 150‚Äì200 calories or adding a 20-minute walk daily to increase your deficit.`
    });
    if (Math.abs(avgWeekly) > 2 && logs.length >= 2) tips.push({
      icon: '‚ö†Ô∏è', hl: false,
      title: 'Losing weight very fast',
      text: `Losing more than 2 lbs/week can cause muscle loss and fatigue. Aim for 0.5‚Äì1.5 lbs/week for sustainable fat loss.`
    });
    if (goal > 0) tips.push({
      icon: 'ü•ó', hl: false,
      title: 'Protect your muscle',
      text: `During a deficit, eat at least 0.7g of protein per lb of bodyweight (${Math.round((currentW || 150) * 0.7)}g/day) to preserve lean muscle.`
    });
    tips.push({
      icon: 'üíß', hl: false,
      title: 'Hydration affects the scale',
      text: 'Daily weight fluctuations of 1‚Äì3 lbs are normal from water, sodium, and digestion. Judge progress week-to-week, not day-to-day.'
    });
    if (remaining !== null && remaining > 0) tips.push({
      icon: 'üéØ', hl: false,
      title: `${remaining.toFixed(1)} lbs to go`,
      text: `At a healthy pace of 1 lb/week, you're looking at about ${Math.ceil(remaining)} weeks. Consistency beats intensity ‚Äî small daily habits compound.`
    });
    tips.push({
      icon: 'üò¥', hl: false,
      title: 'Sleep impacts fat loss',
      text: 'Poor sleep raises cortisol and hunger hormones, making it harder to stay in a deficit. Aim for 7‚Äì9 hours to support your goal.'
    });
  }

  // Always show at least 3 tips
  if (tips.length === 0) tips.push({
    icon: 'üìä', hl: false,
    title: 'Keep logging to unlock insights',
    text: 'Log your weight weekly and track your meals consistently ‚Äî the more data you build up, the more personalized your tips will be.'
  });

  tips.forEach(t => {
    const card = document.createElement('div');
    card.className = 'suggestion-card' + (t.hl ? ' highlight' : '');
    card.innerHTML = `
      <div class="suggestion-icon">${t.icon}</div>
      <div class="suggestion-body">
        <div class="suggestion-title">${t.title}</div>
        <div class="suggestion-text">${t.text}</div>
      </div>`;
    list.appendChild(card);
  });
}

// ============================
// BACKDROPS
// ============================
document.querySelectorAll('.modal-backdrop').forEach(bd => {
  bd.addEventListener('click', e => { if (e.target === bd) bd.classList.remove('open'); });
});

// ============================
// INIT
// ============================
function renderAll() {
  renderHeader();
  renderRing();
  renderProtein();
  renderWeekChart();
  renderEntries();
  renderNote();
  renderNotifications();
}

buildThemeSwatches();
applyTheme(currentTheme);
setGoalType(settings.goalType || 'loss');
setProteinTracking(settings.trackProtein || false);
renderAll();
</script>
</body>
</html>
